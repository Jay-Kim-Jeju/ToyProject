<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="toy.admin.main.dao.AdmMainDAO">

    <select id="selectAdminUserLogin" resultType="SessionAdminVO">
        SELECT T_M.MNGR_UID          /* Manager ID */
        , T_M.PWD_ENCPT         /* Encrypted password */
        , T_M.MNGR_NM           /* Manager name */
        , T_M.EML_ADRES         /* Email */
        , T_M.LAST_LGN_DT       /* Last login datetime */
        , T_M.LGN_FAILR_NUMTM   /* Login failure count */
        FROM TMNGR T_M
        WHERE T_M.USE_YN = 'Y'
        AND T_M.MNGR_UID = #{mngrUid}
    </select>



    <!-- 권한그룹 조회 -->
    <select id="selectAdminUserAuthList" resultType="String">
        SELECT TAM.AUTH_UUID    /* Authorization UUID */
        FROM TAUTH_MNGR TAM
            INNER JOIN TAUTH TA
                ON TA.AUTH_UUID = TAM.AUTH_UUID
        WHERE TAM.MNGR_UID = #{mngrUid}
          AND TA.USE_YN = 'Y'
        <if test="authUuid != null and authUuid != ''">
            AND TAM.AUTH_UUID = #{authUuid}
        </if>
    </select>

    <!-- 최종 로그인 시간 & 로그인 실패 횟수 변경 -->
    <update id="updateLastLogin">
        UPDATE TMNGR
        SET LAST_LGN_DT = NOW()
          , LGN_FAILR_NUMTM = 0
        WHERE MNGR_UID = #{mngrUid}
    </update>

    <!-- 로그인 실패 횟수 변경 -->
    <update id="updateLoginFailCo">
        UPDATE TMNGR
        SET LGN_FAILR_NUMTM = IFNULL(LGN_FAILR_NUMTM, 0) + 1
        WHERE MNGR_UID = #{mngrUid}
    </update>
</mapper>